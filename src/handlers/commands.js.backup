// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥ (hears —Ö–µ–Ω–¥–ª–µ—Ä—ã)
const { registerUser, getUser, getUserById, getUserStats, updateUserRating, getProjectsForAction, getUndoneActionsForProject } = require('../database/models');
const { isUserBanned } = require('../../db');
const { t } = require('../utils/lang');
const { getMainKeyboard, getAdminKeyboard, getUserLevel } = require('../utils/helpers');
const { adminOnly } = require('../middlewares/auth');

/**
 * –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤—Å–µ—Ö –∫–æ–º–∞–Ω–¥–Ω—ã—Ö —Ö–µ–Ω–¥–ª–µ—Ä–æ–≤
 */
function registerCommands(bot) {
  // –ö–æ–º–∞–Ω–¥–∞ /start
  bot.start(async (ctx) => {
    const user = await registerOrGetUser(ctx.from.id, ctx.from.username);
    const stats = await getUserStats(ctx.from.id);

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    const isBanned = await isUserBanned(ctx.from.id);
    if (isBanned && ctx.from.id !== 366323850) {
      const banKeyboard = [['üîì –ü–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫—É']];
      return ctx.reply(t(ctx.session?.language, 'banned_user'), {
        reply_markup: { keyboard: banKeyboard, resize_keyboard: true },
        parse_mode: 'Markdown'
      });
    }

    const keyboard = getMainKeyboard(user, ctx.session?.language);

    ctx.reply(t(ctx.session?.language, 'welcome'), {
      reply_markup: { keyboard: keyboard, resize_keyboard: true },
      parse_mode: 'Markdown'
    });
  });

  // –ö–Ω–æ–ø–∫–∞ "–ú–æ–π —Ä–µ–π—Ç–∏–Ω–≥"
  bot.hears('üìà –ú–æ–π —Ä–µ–π—Ç–∏–Ω–≥', async (ctx) => {
    console.log(`üìà DEBUG: –ü–æ–ª—É—á–µ–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ "–ú–æ–π —Ä–µ–π—Ç–∏–Ω–≥" –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${ctx.from.id} (${ctx.from.username})`);

    const user = await getUser(ctx.from.id);
    console.log(`üìà DEBUG: getUser —Ä–µ–∑—É–ª—å—Ç–∞—Ç: ${user ? '–Ω–∞–π–¥–µ–Ω' : '–Ω–µ –Ω–∞–π–¥–µ–Ω'}`);

    if (!user) {
      console.log('üìà DEBUG: –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏');
      return ctx.reply(t(ctx.session?.language, 'user_registered'));
    }

    // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Ä–µ–π—Ç–∏–Ω–≥ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—É—â–µ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –¥–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏
    await updateUserRating(ctx.from.id);

    // –ü–æ–ª—É—á–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ—Å–ª–µ –ø–µ—Ä–µ—Å—á–µ—Ç–∞
    const updatedUser = await getUser(ctx.from.id);
    const stats = await getUserStats(ctx.from.id);
    const level = getUserLevel(updatedUser.rating);

    let progressText = '';
    if (level.nextLevel) {
      const progress = updatedUser.rating >= level.maxPoints ? 0 : updatedUser.rating;
      const percentage = Math.round((progress / level.maxPoints) * 100);
      progressText = `\n‚≠ê –ü—Ä–æ–≥—Ä–µ—Å—Å –∫ —É—Ä–æ–≤–Ω—é "${level.nextLevel}": ${progress}/${level.maxPoints} (${percentage}%)`;
    } else {
      progressText = '\n‚≠ê –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å –¥–æ—Å—Ç–∏–≥–Ω—É—Ç!';
    }

    // –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç —Å —Ä–µ–π—Ç–∏–Ω–≥–æ–º
    const message = `${level.emoji} **–í–∞—à —É—Ä–æ–≤–µ–Ω—å: ${level.name}**\n\nüìä –†–µ–π—Ç–∏–Ω–≥: ${updatedUser.rating} –±–∞–ª–ª–æ–≤${progressText}`;

    console.log('üìà DEBUG: –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ä–µ–π—Ç–∏–Ω–≥–æ–º');
    ctx.reply(message, { parse_mode: 'Markdown' });
  });

  // –ö–Ω–æ–ø–∫–∞ "‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–µ–∫—Ç"
  bot.hears('‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–µ–∫—Ç', (ctx) => {
    ctx.session = ctx.session || {};
    ctx.reply(t(ctx.session?.language, 'add_project_request'));
    ctx.session.waitingForProject = true;
  });

  // –ö–Ω–æ–ø–∫–∞ "üéØ –î–æ—Å—Ç—É–ø–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è"
  bot.hears('üéØ –î–æ—Å—Ç—É–ø–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è', async (ctx) => {
    console.log(`üéØ DEBUG: –ü–æ–ª—É—á–µ–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ "–î–æ—Å—Ç—É–ø–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è" –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${ctx.from.id} (${ctx.from.username})`);

    const user = await getUser(ctx.from.id);
    console.log(`üéØ DEBUG: getUser —Ä–µ–∑—É–ª—å—Ç–∞—Ç: ${user ? '–Ω–∞–π–¥–µ–Ω' : '–Ω–µ –Ω–∞–π–¥–µ–Ω'}, ID: ${user?.id}, credits: ${user?.credits}`);

    if (!user) {
      console.log('üéØ DEBUG: –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏');
      return ctx.reply(t(ctx.session?.language, 'user_registered'));
    }

    const internalUserId = user.id;

    const platforms = [];
    if (user.behance_username) platforms.push('behance');
    if (user.dribbble_username) platforms.push('dribbble');
    if (user.artstation_username) platforms.push('artstation');
    if (user.dprofile_username) platforms.push('dprofile');

    console.log(`üéØ DEBUG: –ü–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã: ${platforms.join(', ')}`);

    if (platforms.length === 0) {
      console.log('üéØ DEBUG: –ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã—Ö –ø–ª–∞—Ç—Ñ–æ—Ä–º, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö');
      ctx.reply('üîó **–ß—Ç–æ–±—ã –ø–æ–ª—É—á–∞—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∑–∞–¥–∞–Ω–∏—è–º –æ—Ç –¥—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ —Å–≤–æ–∏ –ø—Ä–æ—Ñ–∏–ª–∏ –Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞—Ö!**\n\n–ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -> üîó –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª–∏ –∏ —É–∫–∞–∂–∏—Ç–µ –≤–∞—à–∏ –∞–∫–∫–∞—É–Ω—Ç—ã Behance, Dribbble –∏–ª–∏ ArtStation.\n\n–≠—Ç–æ –ø–æ–∑–≤–æ–ª–∏—Ç –≤–∞–º –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å —Å –∑–∞–¥–∞–Ω–∏—è–º–∏ –Ω–∞ —ç—Ç–∏—Ö –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞—Ö.', {
        reply_markup: { inline_keyboard: [[{ text: '‚öôÔ∏è –ü–µ—Ä–µ–π—Ç–∏ –∫ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º', callback_data: 'settings_profiles' }]] },
        parse_mode: 'Markdown'
      });
      return;
    }



    const projects = await getProjectsForAction(internalUserId, platforms);
    console.log(`üéØ DEBUG: –ù–∞–π–¥–µ–Ω–æ –ø—Ä–æ–µ–∫—Ç–æ–≤ –¥–ª—è –∑–∞–¥–∞–Ω–∏—è: ${projects.length}`);

    if (projects.length === 0) {
      console.log('üéØ DEBUG: –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ');
      ctx.reply('–ü–æ–∫–∞ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π –Ω–∞ –≤–∞—à–∏—Ö –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã—Ö –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞—Ö. –î–æ–±–∞–≤—å—Ç–µ —Å–≤–æ–π –ø—Ä–æ–µ–∫—Ç —Å–Ω–∞—á–∞–ª–∞, —á—Ç–æ–±—ã –¥—Ä—É–≥–∏–µ –º–æ–≥–ª–∏ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –≤–∞—à–∏ –∑–∞–¥–∞–Ω–∏—è.');
      return;
    }

    console.log('üéØ DEBUG: –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ');
    ctx.reply('‚ö†Ô∏è **–í–ê–ñ–ù–û:** –ß—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –∫—Ä–∏—Å—Ç–∞–ª–ª—ã üíé, –≤—ã –î–û–õ–ñ–ù–´ –ø–æ—Å—Ç–∞–≤–∏—Ç—å –Ω–∞—Å—Ç–æ—è—â–∏–π –ª–∞–π–∫/–ø–æ–¥–ø–∏—Å–∫—É/–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –Ω–∞ —Å–∞–π—Ç –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã (Behance/Dribbble/ArtStation).\n\n–°–∏—Å—Ç–µ–º–∞ –æ—Å–Ω–æ–≤–∞–Ω–∞ –Ω–∞ –≤–∑–∞–∏–º–Ω–æ–º –¥–æ–≤–µ—Ä–∏–∏. –ù–µ—Å–æ–±–ª—é–¥–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª –ø—Ä–∏–≤–µ–¥–µ—Ç –∫ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ.');

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –æ–¥–Ω–æ –∑–∞–¥–∞–Ω–∏–µ (–ø–µ—Ä–≤—ã–π –¥–æ—Å—Ç—É–ø–Ω—ã–π –ø—Ä–æ–µ–∫—Ç)
    if (projects.length > 0) {
      const project = projects[0]; // –ë–µ—Ä–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–π –ø—Ä–æ–µ–∫—Ç
      const projectOwner = await getUserById(project.user_id);
      const username = projectOwner ? (projectOwner.username || '–¥–∏–∑–∞–π–Ω–µ—Ä') : '–¥–∏–∑–∞–π–Ω–µ—Ä';
      const ownerId = projectOwner ? projectOwner.id : 0;

      const availableActions = await getUndoneActionsForProject(project.id, internalUserId);

      const keyboard = [
        ...availableActions.map(action => ([{
          text: getActionText(action),
          callback_data: `${action}_project_${project.id}`
        }])),
        [{ text: 'üö® –ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è –Ω–∞ –Ω–∞—Ä—É—à–µ–Ω–∏–µ', callback_data: `complain_${project.id}_${ownerId}` }]
      ].filter(row => row.length > 0);

      const actionType = availableActions[0];
      const credits = await getCreditsForAction(project.id, actionType);
      const actionWord = actionType === 'like' ? '–ª–∞–π–∫' : actionType === 'follow' ? '–ø–æ–¥–ø–∏—Å–∫—É' : actionType === 'comment' ? '–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π' : '–ø—Ä–æ—Å–º–æ—Ç—Ä';

      let actionVerb;
      switch (actionType) {
        case 'view':
          actionVerb = '–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å';
          break;
        case 'like':
          actionVerb = '–ü–æ—Å—Ç–∞–≤–∏—Ç—å –ª–∞–π–∫';
          break;
        case 'follow':
          actionVerb = '–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è';
          break;
        case 'comment':
          actionVerb = '–û—Å—Ç–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π';
          break;
        default:
          actionVerb = '–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å';
      }

      console.log(`üéØ DEBUG: –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–æ–µ–∫—Ç ${project.id} —Å –¥–µ–π—Å—Ç–≤–∏–µ–º ${actionType}`);
      await ctx.reply(`üéØ **${actionVerb} –ø—Ä–æ–µ–∫—Ç—É**\n\nüîó ${project.url}\n\nüí∞ +${credits} üíé –ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è\n\n‚ö†Ô∏è –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –Ω–∞—Å—Ç–æ—è—â–∏–π ${actionWord} –Ω–∞ —Å–∞–π—Ç–µ`, {
        reply_markup: { inline_keyboard: keyboard },
        parse_mode: 'Markdown',
        disable_web_page_preview: true
      });
    }
  });

  // –ö–Ω–æ–ø–∫–∞ "üí∞ –ë–∞–ª–∞–Ω—Å"
  bot.hears('üí∞ –ë–∞–ª–∞–Ω—Å', async (ctx) => {
    console.log(`üîç –î–ï–ë–ê–ì: –ü–æ–∫–∞–∑ –±–∞–ª–∞–Ω—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ${ctx.from.id}`);

    const user = await getUser(ctx.from.id);
    if (!user) {
      console.log('‚ùå –î–ï–ë–ê–ì: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω');
      return ctx.reply(t(ctx.session?.language, 'user_registered'));
    }

    console.log(`‚úÖ –î–ï–ë–ê–ì: –ë–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${ctx.from.username || ctx.from.id}: ${user.credits} –∫—Ä–∏—Å—Ç–∞–ª–ª–æ–≤`);
    console.log('üìã –î–ï–ë–ê–ì: –ü–æ–∫–∞–∑ –∫–Ω–æ–ø–æ–∫ –ø–æ–∫—É–ø–∫–∏ –∫—Ä–∏—Å—Ç–∞–ª–ª–æ–≤');

    ctx.reply(`–í–∞—à–∏ –∫—Ä–∏—Å—Ç–∞–ª–ª—ã üíé: ${user.credits}\n\n–ö—É–ø–∏—Ç—å –∫—Ä–∏—Å—Ç–∞–ª–ª—ã üíé:`, {
      reply_markup: {
        inline_keyboard: [
          [{ text: '100 üíé - 100 ‚ÇΩ', callback_data: 'buy_100' }],
          [{ text: '500 üíé - 450 ‚ÇΩ (—Å–∫–∏–¥–∫–∞)', callback_data: 'buy_500' }],
          [{ text: '1000 üíé - 850 ‚ÇΩ (—Å–∫–∏–¥–∫–∞)', callback_data: 'buy_1000' }]
        ]
      }
    });
  });

  // –ö–Ω–æ–ø–∫–∞ "üìÇ –ú–æ–∏ –ø—Ä–æ–µ–∫—Ç—ã"
  bot.hears('üìÇ –ú–æ–∏ –ø—Ä–æ–µ–∫—Ç—ã', async (ctx) => {
    const user = await getUser(ctx.from.id);
    if (!user) {
      return ctx.reply(t(ctx.session?.language, 'user_registered'));
    }

    const { getUserProjects } = require('../database/models');
    const projects = await getUserProjects(ctx.from.id);

    if (projects.length === 0) {
      ctx.reply('üìÇ –£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –ø—Ä–æ–µ–∫—Ç–æ–≤.\n\n–î–æ–±–∞–≤—å—Ç–µ —Å–≤–æ–π –ø–µ—Ä–≤—ã–π –ø—Ä–æ–µ–∫—Ç —Å –ø–æ–º–æ—â—å—é –∫–Ω–æ–ø–∫–∏ ‚ûï **–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–µ–∫—Ç**!', {
        reply_markup: { inline_keyboard: [[{ text: '‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–µ–∫—Ç', callback_data: 'add_project' }]] },
        parse_mode: 'Markdown'
      });
      return;
    }

    for (const project of projects) {
      const { getActionsForProject } = require('../../db');
      const actions = await getActionsForProject(project.id);
      const actionsCount = actions.length;

      const keyboard = [
        [{ text: 'üìã –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π', callback_data: `view_project_performers_${project.id}` }],
        [{ text: '‚ùå –£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–µ–∫—Ç', callback_data: `delete_project_${project.id}` }]
      ];

      await ctx.reply(`üé® **–ü—Ä–æ–µ–∫—Ç:** ${project.url}\n\nüìä –í—ã–ø–æ–ª–Ω–µ–Ω–æ –¥–µ–π—Å—Ç–≤–∏–π: ${actionsCount}\nüìÖ –î–æ–±–∞–≤–ª–µ–Ω–æ: ${new Date(project.added_date).toLocaleDateString('ru-RU')}`, {
        reply_markup: { inline_keyboard: keyboard },
        parse_mode: 'Markdown'
      });
    }
  });

  // –ö–Ω–æ–ø–∫–∞ "üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞"
  bot.hears('üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞', async (ctx) => {
    const user = await getUser(ctx.from.id);
    if (!user) {
      return ctx.reply(t(ctx.session?.language, 'user_registered'));
    }

    const { getUserDetailedStats } = require('../../db');
    const stats = await getUserDetailedStats(user.telegram_id);
    const avgEarningsPerTask = stats.tasksCompleted > 0 ? Math.round(stats.crystalsEarned / stats.tasksCompleted) : 0;

    const actionStats = `üëÄ –ü—Ä–æ—Å–º–æ—Ç—Ä—ã: ${stats.view || 0}\n‚ù§Ô∏è –õ–∞–π–∫–∏: ${stats.like || 0}\nüí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏: ${stats.comment || 0}\nüë• –ü–æ–¥–ø–∏—Å–∫–∏: ${stats.follow || 0}`;

    const weekActivity = `üìÖ –ó–∞ –ø–æ—Å–ª–µ–¥–Ω—é—é –Ω–µ–¥–µ–ª—é:\n‚Ä¢ –í—ã–ø–æ–ª–Ω–µ–Ω–æ –∑–∞–¥–∞–Ω–∏–π: ${stats.tasksWeek}\n‚Ä¢ –ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ üíé: ${stats.crystalsWeek}\n‚Ä¢ –°—Ä–µ–¥–Ω–∏–π —Ç–µ–º–ø: ${stats.dailyAverage} –≤ –¥–µ–Ω—å`;

    const socialMetrics = `ü§ù –í–∑–∞–∏–º–æ–ø–æ–º–æ—â—å:\n‚Ä¢ –Ø –ø–æ–º–æ–≥ –¥–∏–∑–∞–π–Ω–µ—Ä–∞–º: ${stats.iHelpedOthers}\n‚Ä¢ –ü–æ–º–æ–≥–ª–∏ –º–Ω–µ: ${stats.othersHelpedMe}\n‚Ä¢ –°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ: ${stats.iHelpedOthers + stats.othersHelpedMe > 0 ? (stats.iHelpedOthers > stats.othersHelpedMe ? '–¥–∞—é –±–æ–ª—å—à–µ' : '–ø–æ–ª—É—á–∞—é –±–æ–ª—å—à–µ') : '–≤ –±–∞–ª–∞–Ω—Å–µ'}`;

    const efficiencyBlock = `üìà –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å:\n‚Ä¢ –ó–∞—Å—á–∏—Ç–∞–Ω–æ: ${stats.successRate}%\n‚Ä¢ –í—Å–µ–≥–æ –∑–∞–¥–∞—á: ${stats.tasksTotal}`;

    const bestDayBlock = stats.bestDayWeek ? `\nüéØ –õ—É—á—à–∏–π –¥–µ–Ω—å: ${stats.bestDayWeek.weekday} (${stats.bestDayWeek.tasks} –∑–∞–¥–∞–Ω–∏–π)` : '';

    const message = `üìä **–í–∞—à–∞ –ø–æ–¥—Ä–æ–±–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞**\n\nüí∞ **–û–±—â–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å:**
‚Ä¢ –ó–∞ –≤—Å–µ –≤—Ä–µ–º—è: ${stats.tasksCompleted} –∑–∞–¥–∞–Ω–∏–π
‚Ä¢ –ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ: ${stats.crystalsEarned} üíé
‚Ä¢ –°—Ä–µ–¥–Ω–∏–µ –¥–æ—Ö–æ–¥: ${avgEarningsPerTask} üíé –∑–∞ –∑–∞–¥–∞–Ω–∏–µ
‚Ä¢ –î–æ–±–∞–≤–ª–µ–Ω–æ –ø—Ä–æ–µ–∫—Ç–æ–≤: ${stats.projectsAdded}

${weekActivity}

${actionStats}

${socialMetrics}

${efficiencyBlock}${bestDayBlock}`;

    ctx.reply(message, { parse_mode: 'Markdown' });
  });

  // –ö–Ω–æ–ø–∫–∞ "üèõÔ∏è –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å"
  bot.hears('üèõÔ∏è –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å', adminOnly, (ctx) => {
    console.log(`üèõÔ∏è –ê–î–ú–ò–ù –ü–ê–ù–ï–õ–¨: –ó–∞–ø—Ä–æ—Å –æ—Ç ID ${ctx.from.id}, username ${ctx.from.username}`);

    ctx.reply('üèõÔ∏è **–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å**\n\n–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–æ—Ç–æ–º:', {
      reply_markup: { inline_keyboard: getAdminKeyboard() },
      parse_mode: 'Markdown'
    });
  });

  // –ö–Ω–æ–ø–∫–∞ "‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏"
  bot.hears('‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏', async (ctx) => {
    const user = await getUser(ctx.from.id);
    if (!user) {
      return ctx.reply(t(ctx.session?.language, 'user_registered'));
    }

    const keyboard = [
      [{ text: 'üîó –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª–∏', callback_data: 'settings_profiles' }],
      [{ text: 'üåç –ò–∑–º–µ–Ω–∏—Ç—å —è–∑—ã–∫', callback_data: 'settings_language' }],
      [{ text: 'üîô –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é', callback_data: 'back_to_main' }]
    ];

    ctx.reply(t(ctx.session?.language, 'settings'), {
      reply_markup: { inline_keyboard: keyboard }
    });
  });

  // –ö–æ–º–∞–Ω–¥–∞ /admin –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
  bot.hears('/admin', adminOnly, (ctx) => {
    console.log(`üîß /ADMIN: –ö–û–ú–ê–ù–î–ê –û–ë–ù–ê–†–£–ñ–ï–ù–ê! ID: ${ctx.from.id}, username: ${ctx.from.username}`);

    ctx.reply('üèõÔ∏è **–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å**\n\n–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:', {
      reply_markup: { inline_keyboard: getAdminKeyboard() },
      parse_mode: 'Markdown'
    });
  });

  bot.hears(/^admin$/i, adminOnly, (ctx) => {
    console.log(`üîß ADMIN TEXT: –í—ã–∑–≤–∞–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ID: ${ctx.from.id}, username: ${ctx.from.username}`);
    ctx.reply('–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /admin');
  });
}

/**
 * –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏–ª–∏ –ø–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
 */
async function registerOrGetUser(telegramId, username) {
  await registerUser(telegramId, username);
  return await getUser(telegramId);
}



module.exports = registerCommands;
