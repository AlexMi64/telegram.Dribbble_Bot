// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ callback actions (inline-–∫–Ω–æ–ø–∫–∏)
const {
  getUser,
  updateUserProfile,
  getUserById,
  addProject,
  getProjectById,
  addActionTransaction,
  updateCredits,
  buyCredits,
  saveComplaint,
  getPendingComplaints,
  getComplaintById,
  updateComplaintStatus,
  banUser,
  unbanUser,
  getUserDetailedStats,
  getUserWarningsCount,
  incrementUserWarnings,
  getAllActiveUsers,
  sendBroadcastMessage,
  hasUserDoneAction,
  getCreditsForAction,
  updateUserRating
} = require('../database/models');

// –ü–æ–ª—É—á–∞–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏–∑ db.js
const {
  decrementCredits,
  getActionText,
  detectPlatform,
  isValidProjectUrl,
  getLinkType,
  showProjectActionsMenu,
  getUserPlatforms,
  showNextTask
} = require('../../db');

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π –±–æ—Ç–∞
function registerActions(bot) {

  // Action –¥–ª—è –ø–æ–∫—É–ø–∫–∏ –∫—Ä–∏—Å—Ç–∞–ª–ª–æ–≤
  bot.action(/^buy_(\d+)$/, async (ctx) => {
    const amount = parseInt(ctx.match[1]);

    await ctx.answerCbQuery();

    const user = await getUser(ctx.from.id);
    if (!user) {
      await ctx.editMessageText('–°–Ω–∞—á–∞–ª–∞ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å —á–µ—Ä–µ–∑ /start');
      return;
    }

    const prices = { 100: 100, 500: 450, 1000: 850 };
    const cost = prices[amount];

    await ctx.editMessageText(`–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ–ø–ª–∞—Ç—ã ${amount} üíé –∑–∞ ${cost} ‚ÇΩ`, {
      reply_markup: {
        inline_keyboard: [
          [{ text: '–û–ø–ª–∞—Ç–∏—Ç—å', callback_data: `confirm_buy_${amount}` }]
        ]
      }
    });
  });



  // Actions –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ—Ñ–∏–ª–µ–π –ø–ª–∞—Ç—Ñ–æ—Ä–º
  bot.action('settings_profiles', async (ctx) => {
    const user = await getUser(ctx.from.id);
    ctx.editMessageText(
      `üîó **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ—Ñ–∏–ª–µ–π**\n\n–ü–æ–¥–∫–ª—é—á–∏—Ç–µ —Å–≤–æ–∏ –ø—Ä–æ—Ñ–∏–ª–∏ –Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞—Ö –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ª–∞–π–∫–æ–≤:\n\n–¢–µ–∫—É—â–∏–µ –ø—Ä–æ—Ñ–∏–ª–∏:\n‚Ä¢ Behance: ${user.behance_username || '–Ω–µ —É–∫–∞–∑–∞–Ω'}\n‚Ä¢ Dribbble: ${user.dribbble_username || '–Ω–µ —É–∫–∞–∑–∞–Ω'}\n‚Ä¢ ArtStation: ${user.artstation_username || '–Ω–µ —É–∫–∞–∑–∞–Ω'}\n‚Ä¢ Dprofile: ${user.dprofile_username || '–Ω–µ —É–∫–∞–∑–∞–Ω'}`, {
      reply_markup: {
        inline_keyboard: [
          [{ text: 'üé® Behance –ø—Ä–æ—Ñ–∏–ª—å', callback_data: 'set_behance' }],
          [{ text: 'üéØ Dribbble –ø—Ä–æ—Ñ–∏–ª—å', callback_data: 'set_dribbble' }],
          [{ text: '‚ú® ArtStation –ø—Ä–æ—Ñ–∏–ª—å', callback_data: 'set_artstation' }],
          [{ text: 'üì∞ Dprofile –ø—Ä–æ—Ñ–∏–ª—å', callback_data: 'set_dprofile' }],
          [{ text: 'üëÄ –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –º–æ–∏ –ø—Ä–æ—Ñ–∏–ª–∏', callback_data: 'view_profiles' }],
          [{ text: 'üîô –ù–∞–∑–∞–¥ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏', callback_data: 'back_to_settings' }]
        ]
      },
      parse_mode: 'Markdown'
    });
  });

  bot.action('set_behance', async (ctx) => {
    ctx.session = ctx.session || {};
    ctx.session.waitingForBehance = true;
    ctx.editMessageText(
      `üé® **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ Behance –ø—Ä–æ—Ñ–∏–ª—è**\n\n–£–∫–∞–∂–∏—Ç–µ –≤–∞—à Behance username (–∏–º—è –ø—Ä–æ—Ñ–∏–ª—è –ø–æ—Å–ª–µ behance.net/).\n\n–ü—Ä–∏–º–µ—Ä: –¥–ª—è https://www.behance.net/alexdesign –≤–≤–µ–¥–∏—Ç–µ: **alexdesign**\n\n–ò–ª–∏ —É–∫–∞–∂–∏—Ç–µ –ø–æ–ª–Ω—ã–π URL –ø—Ä–æ—Ñ–∏–ª—è.`, {
      reply_markup: { inline_keyboard: [[{ text: 'üîô –ù–∞–∑–∞–¥', callback_data: 'settings_profiles' }]] },
      parse_mode: 'Markdown'
    });
  });

  bot.action('set_dribbble', async (ctx) => {
    ctx.session = ctx.session || {};
    ctx.session.waitingForDribbble = true;
    ctx.editMessageText(
      `üéØ **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ Dribbble –ø—Ä–æ—Ñ–∏–ª—è**\n\n–£–∫–∞–∂–∏—Ç–µ –≤–∞—à Dribbble username (–∏–º—è –ø—Ä–æ—Ñ–∏–ª—è –ø–æ—Å–ª–µ dribbble.com/).\n\n–ü—Ä–∏–º–µ—Ä: –¥–ª—è https://dribbble.com/alexdesign –≤–≤–µ–¥–∏—Ç–µ: **alexdesign**\n\n–ò–ª–∏ —É–∫–∞–∂–∏—Ç–µ –ø–æ–ª–Ω—ã–π URL –ø—Ä–æ—Ñ–∏–ª—è.`, {
      reply_markup: { inline_keyboard: [[{ text: 'üîô –ù–∞–∑–∞–¥', callback_data: 'settings_profiles' }]] },
      parse_mode: 'Markdown'
    });
  });

  bot.action('set_artstation', async (ctx) => {
    ctx.session = ctx.session || {};
    ctx.session.waitingForArtstation = true;
    ctx.editMessageText(
      `‚ú® **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ ArtStation –ø—Ä–æ—Ñ–∏–ª—è**\n\n–£–∫–∞–∂–∏—Ç–µ –≤–∞—à ArtStation username (–∏–º—è –ø—Ä–æ—Ñ–∏–ª—è –ø–æ—Å–ª–µ artstation.com/).\n\n–ü—Ä–∏–º–µ—Ä: –¥–ª—è https://www.artstation.com/alexdesign –≤–≤–µ–¥–∏—Ç–µ: **alexdesign**\n\n–ò–ª–∏ —É–∫–∞–∂–∏—Ç–µ –ø–æ–ª–Ω—ã–π URL –ø—Ä–æ—Ñ–∏–ª—è.`, {
      reply_markup: { inline_keyboard: [[{ text: 'üîô –ù–∞–∑–∞–¥', callback_data: 'settings_profiles' }]] },
      parse_mode: 'Markdown'
    });
  });

  bot.action('set_dprofile', async (ctx) => {
    ctx.session = ctx.session || {};
    ctx.session.waitingForDprofile = true;
    ctx.editMessageText(
      `üì∞ **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ Dprofile –ø—Ä–æ—Ñ–∏–ª—è**\n\n–£–∫–∞–∂–∏—Ç–µ –≤–∞—à Dprofile username (–∏–º—è –ø—Ä–æ—Ñ–∏–ª—è –ø–æ—Å–ª–µ dprofile.ru/).\n\n–ü—Ä–∏–º–µ—Ä: –¥–ª—è https://dprofile.ru/alexdesign –≤–≤–µ–¥–∏—Ç–µ: **alexdesign**\n\n–ò–ª–∏ —É–∫–∞–∂–∏—Ç–µ –ø–æ–ª–Ω—ã–π URL –ø—Ä–æ—Ñ–∏–ª—è.`, {
      reply_markup: { inline_keyboard: [[{ text: 'üîô –ù–∞–∑–∞–¥', callback_data: 'settings_profiles' }]] },
      parse_mode: 'Markdown'
    });
  });

  bot.action('view_profiles', async (ctx) => {
    const user = await getUser(ctx.from.id);
    ctx.editMessageText(
      `üëÄ **–í–∞—à–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª–∏**\n\n*Behance:* ${user.behance_username ? `https://behance.net/${user.behance_username}` : '–Ω–µ —É–∫–∞–∑–∞–Ω'}\n*Dribbble:* ${user.dribbble_username ? `https://dribbble.com/${user.dribbble_username}` : '–Ω–µ —É–∫–∞–∑–∞–Ω'}\n*ArtStation:* ${user.artstation_username ? `https://artstation.com/${user.artstation_username}` : '–Ω–µ —É–∫–∞–∑–∞–Ω'}\n\n–ü–æ–¥–∫–ª—é—á–∏—Ç–µ –≤–∞—à–∏ –ø—Ä–æ—Ñ–∏–ª–∏ –¥–ª—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ª–∞–π–∫–æ–≤ —á–µ—Ä–µ–∑ API.`, {
      reply_markup: {
        inline_keyboard: [
          [{ text: 'üîó –ò–∑–º–µ–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª–∏', callback_data: 'settings_profiles' }],
          [{ text: 'üîô –ù–∞–∑–∞–¥ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏', callback_data: 'back_to_settings' }]
        ]
      },
      parse_mode: 'Markdown'
    });
  });

  // Actions –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞–Ω–∏–π
  bot.action(/^(\w+)_project_(\d+)$/, async (ctx) => {
    const actionType = ctx.match[1];
    const projectId = ctx.match[2];
    const userId = ctx.from.id;

    if (!["like", "follow", "comment", "view"].includes(actionType)) {
      return;
    }

    const alreadyDone = await hasUserDoneAction(userId, projectId, actionType);
    if (alreadyDone) {
      return;
    }

    const project = await getProjectById(projectId);
    if (!project) {
      await ctx.reply('–ü—Ä–æ–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω');
      return;
    }

    if (project.user_id === userId) {
      await ctx.reply('–í—ã –Ω–µ –º–æ–∂–µ—Ç–µ –≤—ã–ø–æ–ª–Ω—è—Ç—å –¥–µ–π—Å—Ç–≤–∏—è –Ω–∞ —Å–≤–æ–µ–º —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ');
      return;
    }

    try {
      await ctx.deleteMessage(ctx.callbackQuery.message.message_id);
    } catch (error) {}

    const actionWord = actionType === 'like' ? '–ª–∞–π–∫' : actionType === 'follow' ? '–ø–æ–¥–ø–∏—Å–∫—É' : actionType === 'comment' ? '–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π' : '–ø—Ä–æ—Å–º–æ—Ç—Ä';

    await ctx.reply(`üéØ **–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫—Ä–∏—Å—Ç–∞–ª–ª–æ–≤ üíé –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:***\n\n${actionType === 'like' ? '–ü–æ—Å—Ç–∞–≤—å—Ç–µ –ª–∞–π–∫' : actionType === 'follow' ? '–ü–æ–¥–ø–∏—à–∏—Ç–µ—Å—å' : actionType === 'comment' ? '–û—Å—Ç–∞–≤—å—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π' : '–ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç'} –Ω–∞ –ø—Ä–æ–µ–∫—Ç–µ –Ω–∏–∂–µ:\n\nüîó ${project.url}\n\n‚ö†Ô∏è **–í–ê–ñ–ù–û:** –í—ã–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞—Å—Ç–æ—è—â–µ–µ ${actionWord} –Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ!\n\n–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏—è –Ω–∞–∂–º–∏—Ç–µ "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ"`, {
      reply_markup: {
        inline_keyboard: [
          [{ text: 'üîó –û—Ç–∫—Ä—ã—Ç—å –ø—Ä–æ–µ–∫—Ç', url: project.url }],
          [{ text: `‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ`, callback_data: `confirm_${actionType}_${projectId}` }]
        ]
      },
      parse_mode: 'Markdown'
    });
  });

  // Actions –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–æ–≤
  bot.action(/^select_(\w+)$/, async (ctx) => {
    const actionType = ctx.match[1];
    // –≠—Ç–∏ handlers —É–ø—Ä–∞–≤–ª—è—é—Ç –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –≤ text handlers,
    // –Ω–æ –Ω—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
    ctx.session.waitingForViewsCount = actionType === 'views';
    ctx.session.waitingForLikesCount = actionType === 'likes';
    ctx.session.waitingForCommentsCount = actionType === 'comments';
    ctx.session.waitingForFollowsCount = actionType === 'follows';

    let countType = actionType === 'views' ? '–ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤' :
                   actionType === 'likes' ? '–ª–∞–π–∫–æ–≤' :
                   actionType === 'comments' ? '–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤' :
                   actionType === 'follows' ? '–ø–æ–¥–ø–∏—Å–æ–∫' : '';

    await ctx.editMessageText(`–û—Ç–ª–∏—á–Ω–æ! –¢–µ–ø–µ—Ä—å —É–∫–∞–∂–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ ${countType} (1-1000):`, {
      reply_markup: { inline_keyboard: [[{ text: '‚ùå –û—Ç–º–µ–Ω–∏—Ç—å', callback_data: 'cancel_project_add' }]] },
      parse_mode: 'Markdown'
    });
  });

  // –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã–µ actions
  bot.action('back_to_main', async (ctx) => {
    const stats = await require('../database/models').getUserStats(ctx.from.id);
    let keyboard = [
      [{ text: 'üéØ –î–æ—Å—Ç—É–ø–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è', callback_data: 'menu_available_tasks' }, { text: '‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–µ–∫—Ç', callback_data: 'menu_add_project' }],
      [{ text: 'üìÇ –ú–æ–∏ –ø—Ä–æ–µ–∫—Ç—ã', callback_data: 'menu_my_projects' }],
      [{ text: 'üìà –ú–æ–π —Ä–µ–π—Ç–∏–Ω–≥', callback_data: 'menu_rating' }, { text: 'üí∞ –ë–∞–ª–∞–Ω—Å', callback_data: 'menu_balance' }],
      [{ text: '‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏', callback_data: 'menu_settings' }]
    ];

    if (ctx.from.id === parseInt(process.env.ADMIN_ID || '366323850')) {
      keyboard.push([{ text: 'üèõÔ∏è –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å', callback_data: 'admin_panel' }]);
    }

    await ctx.editMessageText('ü§ù **–í–∑–∞–∏–º–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –¥–∏–∑–∞–π–Ω–µ—Ä–æ–≤ –≤ DesignLike**\n\nüé® Behance | Dribbble | ArtStation | Dprofile\n\nüî• –°–∏—Å—Ç–µ–º–∞ –≤–∑–∞–∏–º–Ω–æ–π —Ä–µ–∫–ª–∞–º—ã: –ø–æ–º–æ–≥–∞–µ–º –¥—Ä—É–≥ –¥—Ä—É–≥—É —Ä–∞—Å—Ç–∏!\n\n–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:', {
      reply_markup: { inline_keyboard: keyboard },
      parse_mode: 'Markdown',
      disable_web_page_preview: true
    });
  });

  // Actions –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞
  bot.action('confirm_project_add', async (ctx) => {
    const project = ctx.session.pendingProject;
    const selectedActions = ctx.session.selectedActions;

    if (!project || !selectedActions) {
      await ctx.editMessageText('‚ùå –î–∞–Ω–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.');
      return;
    }

    const user = await getUser(ctx.from.id);
    if (!user) {
      await ctx.editMessageText('‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω.');
      return;
    }

    const totalCredits = selectedActions.views * 1 + selectedActions.likes * 5 + selectedActions.comments * 10 + selectedActions.follows * 30;

    if (user.credits < totalCredits) {
      await ctx.editMessageText(`‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫—Ä–∏—Å—Ç–∞–ª–ª–æ–≤! –£ –≤–∞—Å ${user.credits} üíé, —Ç—Ä–µ–±—É–µ—Ç—Å—è ${totalCredits} üíé.`);
      return;
    }

    // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ–µ–∫—Ç –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
    const projectId = await addProject(ctx.from.id, project.url, project.platform);
    if (projectId) {
      // –°–æ–∑–¥–∞–µ–º –¥–µ–π—Å—Ç–≤–∏—è –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞ –≤ –ë–î
      const { db } = require('../../db');

      // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º insert queries –¥–ª—è –≤—Å–µ—Ö –¥–µ–π—Å—Ç–≤–∏–π
      const insertPromises = [];

      for (let i = 0; i < selectedActions.views; i++) {
        insertPromises.push(new Promise((resolve, reject) => {
          db.run('INSERT INTO project_actions (project_id, action_type, credits_per_action) VALUES (?, ?, ?)',
            [projectId, 'view', 1], function(err) { err ? reject(err) : resolve(this.lastID); });
        }));
      }

      for (let i = 0; i < selectedActions.likes; i++) {
        insertPromises.push(new Promise((resolve, reject) => {
          db.run('INSERT INTO project_actions (project_id, action_type, credits_per_action) VALUES (?, ?, ?)',
            [projectId, 'like', 5], function(err) { err ? reject(err) : resolve(this.lastID); });
        }));
      }

      for (let i = 0; i < selectedActions.comments; i++) {
        insertPromises.push(new Promise((resolve, reject) => {
          db.run('INSERT INTO project_actions (project_id, action_type, credits_per_action) VALUES (?, ?, ?)',
            [projectId, 'comment', 10], function(err) { err ? reject(err) : resolve(this.lastID); });
        }));
      }

      for (let i = 0; i < selectedActions.follows; i++) {
        insertPromises.push(new Promise((resolve, reject) => {
          db.run('INSERT INTO project_actions (project_id, action_type, credits_per_action) VALUES (?, ?, ?)',
            [projectId, 'follow', 30], function(err) { err ? reject(err) : resolve(this.lastID); });
        }));
      }

      try {
        await Promise.all(insertPromises);

        // –°–Ω–∏–º–∞–µ–º –∫—Ä–µ–¥–∏—Ç—ã —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        await updateCredits(ctx.from.id, user.credits - totalCredits);

        await ctx.editMessageText(`‚úÖ **–ü—Ä–æ–µ–∫—Ç —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!**\n\nüîó ${project.url}\n\nüí∞ –°–ø–∏—Å–∞–Ω–æ: ${totalCredits} üíé\n\n–î—Ä—É–≥–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å–º–æ–≥—É—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å –¥–µ–π—Å—Ç–≤–∏—è –Ω–∞ –≤–∞—à–µ–º –ø—Ä–æ–µ–∫—Ç–µ.`);
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏–π –ø—Ä–æ–µ–∫—Ç–∞:', error);
        await ctx.editMessageText('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –¥–µ–π—Å—Ç–≤–∏–π –ø—Ä–æ–µ–∫—Ç–∞.');
        return;
      }
    } else {
      await ctx.editMessageText('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞.');
    }

    // –û—á–∏—â–∞–µ–º —Å–µ—Å—Å–∏—é
    delete ctx.session.pendingProject;
    delete ctx.session.selectedActions;
  });

  bot.action('cancel_project_add', async (ctx) => {
    ctx.editMessageText('‚ùå –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞ –æ—Ç–º–µ–Ω–µ–Ω–æ.');
    delete ctx.session.pendingProject;
    delete ctx.session.selectedActions;
  });

  // –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–µ–∫—Ç –∏–∑ –º–µ–Ω—é
  bot.action('add_project', async (ctx) => {
    ctx.reply('–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ –≤–∞—à –ø—Ä–æ–µ–∫—Ç (Behance, Dribbble, ArtStation):');
    ctx.session = ctx.session || {};
    ctx.session.waitingForProject = true;
  });

  // –ê–¥–º–∏–Ω –¥–µ–π—Å—Ç–≤–∏—è
  bot.action('admin_broadcast', async (ctx) => {
    if (ctx.from.id !== 366323850) return;

    ctx.session = ctx.session || {};
    ctx.session.waitingForBroadcastMessage = true;
    ctx.editMessageText('üì§ **–†–∞—Å—Å—ã–ª–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º**\n\n–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –±—É–¥–µ—Ç —Ä–∞–∑–æ—Å–ª–∞–Ω–æ –≤—Å–µ–º –∞–∫—Ç–∏–≤–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –±–æ—Ç–∞ (–Ω–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–º).\n\n‚ö†Ô∏è **–í–Ω–∏–º–∞–Ω–∏–µ:** –°–æ–æ–±—â–µ–Ω–∏–µ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ!', {
      reply_markup: { inline_keyboard: [[{ text: '‚ùå –û—Ç–º–µ–Ω–∏—Ç—å', callback_data: 'back_to_admin' }]] },
      parse_mode: 'Markdown'
    });
  });

  bot.action(/^confirm_broadcast_send$/, async (ctx) => {
    if (ctx.from.id !== 366323850) return;

    const messageText = ctx.session.broadcastMessage;
    if (!messageText) {
      ctx.editMessageText('‚ùå –û—à–∏–±–∫–∞: —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
      return;
    }

    // –û—á–∏—â–∞–µ–º —Å–µ—Å—Å–∏—é
    delete ctx.session.broadcastMessage;

    // –£–≤–µ–¥–æ–º–ª—è–µ–º, —á—Ç–æ —Ä–∞—Å—Å—ã–ª–∫–∞ –Ω–∞—á–∞–ª–∞—Å—å
    ctx.editMessageText('üì§ –†–∞—Å—Å—ã–ª–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è...\n\n‚è≥ –ü–æ–¥–æ–∂–¥–∏—Ç–µ, –∏–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º...');

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–∞—Å—Å—ã–ª–∫—É
    try {
      const result = await sendBroadcastMessage(ctx, messageText, ctx.from.id);
      ctx.editMessageText(`‚úÖ –†–∞—Å—Å—ã–ª–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!\n\nüì§ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: ${result.sentCount} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º\n‚ùå –û—à–∏–±–æ–∫: ${result.errors.length}\n\nüìÖ ${new Date().toLocaleString('ru-RU')}`, {
        reply_markup: { inline_keyboard: [[{ text: 'üîô –ù–∞–∑–∞–¥ –≤ –∞–¥–º–∏–Ω –º–µ–Ω—é', callback_data: 'back_to_admin' }]] }
      });
    } catch (error) {
      console.error('Error sending broadcast:', error);
      ctx.editMessageText('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ä–∞—Å—Å—ã–ª–∫–∏.', {
        reply_markup: { inline_keyboard: [[{ text: 'üîô –ù–∞–∑–∞–¥ –≤ –∞–¥–º–∏–Ω –º–µ–Ω—é', callback_data: 'back_to_admin' }]] }
      });
    }
  });

  bot.action('cancel_broadcast', async (ctx) => {
    if (ctx.from.id !== 366323850) return;

    // –û—á–∏—â–∞–µ–º —Å–µ—Å—Å–∏—é
    delete ctx.session.broadcastMessage;

    ctx.editMessageText('‚ùå –†–∞—Å—Å—ã–ª–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞.', {
      reply_markup: { inline_keyboard: [[{ text: 'üîô –ù–∞–∑–∞–¥ –≤ –∞–¥–º–∏–Ω –º–µ–Ω—é', callback_data: 'back_to_admin' }]] }
    });
  });

  // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–æ–∫—É–ø–∫–∏ –∫—Ä–∏—Å—Ç–∞–ª–ª–æ–≤
  bot.action(/^confirm_buy_(\d+)$/, async (ctx) => {
    await ctx.answerCbQuery();

    const amount = parseInt(ctx.match[1]);
    const user = await getUser(ctx.from.id);
    if (!user) {
      await ctx.editMessageText('–°–Ω–∞—á–∞–ª–∞ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å —á–µ—Ä–µ–∑ /start');
      return;
    }

    await buyCredits(ctx.from.id, amount);
    await ctx.editMessageText(`‚úÖ –û–ø–ª–∞—Ç–∞ –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ! –ù–∞—á–∏—Å–ª–µ–Ω–æ ${amount} üíé.`);
  });

  // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞–Ω–∏—è
  bot.action(/^confirm_(?!buy)(\w+)_(\d+)$/, async (ctx) => {
    const actionType = ctx.match[1];
    const projectId = ctx.match[2];
    const userId = ctx.from.id;

    // –ü–æ–ª—É—á–∞–µ–º –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const user = await getUser(userId);
    if (!user) {
      await ctx.reply('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω.');
      return;
    }

    let alreadyDone = await hasUserDoneAction(user.id, projectId, actionType);

    // –î–ª—è –ø–æ–¥–ø–∏—Å–∫–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –ø–æ–¥–ø–∏—Å—ã–≤–∞–ª—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞ —ç—Ç–æ—Ç URL –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π
    if (actionType === 'follow' && !alreadyDone) {
      const project = await getProjectById(projectId);
      if (project) {
        alreadyDone = await hasUserDoneFollowOnUrl(user.id, project.url);
      }
    }

    if (alreadyDone) {
      if (actionType === 'follow') {
        await ctx.editMessageText('‚ö†Ô∏è –í—ã —É–∂–µ –≤—ã–ø–æ–ª–Ω—è–ª–∏ –ø–æ–¥–ø–∏—Å–∫—É –Ω–∞ —ç—Ç–æ—Ç –ø—Ä–æ—Ñ–∏–ª—å –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π. –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ —Ç–æ—Ç –∂–µ URL –Ω–µ–≤–æ–∑–º–æ–∂–Ω—ã.', {
          reply_markup: { inline_keyboard: [[{ text: 'üîô –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –∑–∞–¥–∞–Ω–∏—è–º', callback_data: 'back_to_main' }]] },
          parse_mode: 'Markdown'
        }).catch(() => {});
      } else {
        await ctx.editMessageText('‚ö†Ô∏è –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ —É–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ.', {
          reply_markup: { inline_keyboard: [[{ text: 'üîô –ù–∞–∑–∞–¥ –∫ –∑–∞–¥–∞–Ω–∏—é', callback_data: `${actionType}_project_${projectId}` }]] },
          parse_mode: 'Markdown'
        }).catch(() => {});
      }
      return;
    }

    try {
      await ctx.deleteMessage(ctx.callbackQuery.message.message_id);
    } catch (error) {}

    const credits = await getCreditsForAction(projectId, actionType);
    const transaction = await addActionTransaction(userId, projectId, actionType);
    if (transaction) {
      const user = await getUser(userId);
      await updateCredits(user.id, user.credits + credits);
      await updateUserRating(userId);

      const thankYouMessage = await ctx.reply(`‚úÖ –°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∑–∞–∏–º–Ω—É—é –ø–æ–¥–¥–µ—Ä–∂–∫—É!\n\nüí∞ +${credits} –∫—Ä–µ–¥–∏—Ç${credits !== 1 ? '–æ–≤' : ''} –Ω–∞—á–∏—Å–ª–µ–Ω${credits !== 1 ? '—ã' : ''} –∑–∞ ${getActionText(actionType).toLowerCase()}!`);

      // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID —Å–æ–æ–±—â–µ–Ω–∏—è "–°–ø–∞—Å–∏–±–æ!", —á—Ç–æ–±—ã –ø–æ—Ç–æ–º —É–¥–∞–ª–∏—Ç—å
      ctx.session.thankYouMessageId = thankYouMessage.message_id;

      setTimeout(async () => {
        const platforms = await getUserPlatforms(user.id);
        await showNextTask(ctx, user.id, platforms);
      }, 1000);
    } else {
      await ctx.reply(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ ${getActionText(actionType).toLowerCase()}. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.`);
    }
  });

  console.log('üîÑ Action handlers –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã');
}

module.exports = { registerActions };
